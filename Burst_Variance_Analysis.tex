\section{Implementing Burst Variance Analysis}

\label{sec:bva}
In this section we describe how to implement the burst variance analysis (BVA)~\cite{Torella_2011}.
FRETBurts provides well-tested, general-purpose functions for timestamps and burst data 
manipulation and therefore simplifies implementing custom burst analysis algorithms such as BVA.

\subsection{BVA Overview}
Single-molecule FRET histograms show more information than just mean FRET efficiencies. 
While, in general, several peaks indicate the presence of multiple subpopulations, 
a single peak cannot be a priori associated with a single FRET efficiency,
unless a detailed shot-noise analysis is carried out~\cite{Nir_2006,Antonik2006}.

The width of a FRET distribution has a typical lower boundary set by shot noise, which is caused by
the statistics of discrete photon-detection events. FRET distributions broader than the shot noise limit, 
can be ascribed to a static mixture of species with slightly different FRET efficiencies, 
or to a specie undergoing dynamic transitions (e.g. interconversion between multiple states,
diffusion in a continuum of conformations, binding-unbinding events, etc...).
By simply looking at the FRET histogram,  in cases when there is single peak broader than shot-noise, 
it is not possible to discriminate between the static and dynamic case.
The BVA method has been developed to address this issue of detecting the presence of dynamics 
in FRET distributions~\cite{Torella_2011}, 
and has been successfully applied to identify biomolecular processes with 
dynamics on the millisecond time-scale~\cite{Torella_2011, Robb_2013}.

The basic idea behind BVA is to slice bursts in sub-bursts with a fixed number of photons $n$,
and to compare the empirical variance of acceptor counts across all sub-bursts in a burst 
with the theoretical shot-noise limited variance, dictated by the Binomial distribution.
An empirical variance of sub-bursts larger than the shot-noise limited value indicates
the presence of dynamics. Since the estimation of the sub-bursts variance is affected
by uncertainty, BVA analysis provides and indication of an higher or lower probability
of observing dynamics.

In a FRET (sub-)population originating from a single static FRET efficiency,
the sub-bursts acceptor counts $N_a$ can be modeled as a Binomial-distributed random variable 
$N_a \sim \operatorname{Binom} \{n, E\}$, where $n$ is the number of photons in each sub-burst and 
$E$ is the estimated population FRET efficiency. Note that, without approximation, we can replace 
E with PR and use the uncorrected counts. This is possible because, regardless of the 
molecular FRET efficiency, the detected counts are partitioned between donor and acceptor channel
according to a Binomial distribution with a $p$ parameter equal to PR.
The only approximation done here is neglecting the presence background
(a reasonable approximation since the backgrounds counts are in general a very small fraction of
the total counts). 
We refer the interested reader to~\cite{Torella_2011} for further discussion.

If $N_a$ follows a Binomial distribution, the random variable $E = N_a/n$,
has standard deviation reported in eq.~\ref{eq:binom_std}. 

\begin{equation}
\label{eq:binom_std}
\operatorname{Std(\textit{E})} = {\sqrt{\frac{E(1 - E)}{n}}}
\end{equation}

BVA analysis consists of four steps: 1) slicing bursts into sub-bursts containing a constant number of consecutive photons,~\textit{n}, 2) computing FRET efficiencies of each sub-burst, 3) calculating the empirical standard deviation ($s_E$) of sub-burst FRET efficiencies over the whole burst, and 4) comparing $s_E$ to the expected standard deviation of a shot-noise limited distribution~(eq.~\ref{eq:binom_std}).
If, as in figure~\ref{fig:bva_static}, the observed FRET efficiency distribution 
originates from a static mixture of FRET efficiency sub-populations (of different 
non-interconverting molecules), 
$s_E$ of each burst is only affected by shot noise and will follow the expected standard deviation curve based on eq.~\ref{eq:binom_std}. 
Conversely, if the observed distribution originates from biomolecules of a single specie, which 
interconverts between different FRET sub-populations in (times comparable to diffusion 
time), as in figure~\ref{fig:bva_dynamic}, $s_E$ of each burst will be larger than the expected 
shot-noise-limited standard deviation, hence it will be placed above the shot-noise standard 
deviation curve (right panel on figure~\ref{fig:bva_dynamic}).

\subsection{BVA Implementation}

The following paragraphs describe the low-level details involved in implementing the BVA using FRETBursts.
The main goal is showing a real-world example of accessing and manipulating timestamps and burst data.
For a ready-to-use BVA implementation users can refer to the relative notebook included with FRETBursts
(\href{http://nbviewer.jupyter.org/github/tritemio/FRETBursts_notebooks/blob/master/notebooks/Example%20-%20Burst%20Variance%20Analysis.ipynb}{link}).

\paragraph{Python details}
For implementing BVA we need two photon streams: photon during donor excitation (Dex) 
and acceptor photon during donor excitation (DexAem). 
These photon selections are obtained by computing boolean masks as follows 
(see section~\ref{sec:burststimes}):

\begin{lstlisting}
Dex_mask = ds.get_ph_mask(ph_sel=Ph_sel(Dex='DAem'))   
DexAem_mask = ds.get_ph_mask(ph_sel=Ph_sel(Dex='Aem'))
DexAem_mask_d = AemDex_mask[Dex_mask]
\end{lstlisting}

Here, the first two variables (\verb|Dex_mask| and \verb|DexAem_mask|) are used to
select photon from the all-photons timestamps array,
while \verb|DexAem_mask_d|, selects A-emitted photons from the
array of photons emitted during D-excitation. As shown below, 
the latter is needed to count acceptor photons in sub-bursts.

Next, we need burst data relative to D-excitation photon stream (by default 
burst start-stop index refer to all-photons timestamps array):

\begin{lstlisting}
ph_d = ds_FRET.get_ph_times(ph_sel=Ph_sel(Dex='DAem'))
bursts = ds_FRET.mburst[0] 
bursts_d = bursts.recompute_index_reduce(ph_d)
\end{lstlisting}

Here, \verb|ph_d| contains the Dex timestamps, \verb|bursts| the original burst data and 
\verb|bursts_d| the burst data with start-stop indexes relative to \verb|ph_d|.

Finally, with the previous variables at hand, we can easily implement the BVA algorithm
by computing the $s_E$ quantity for each burst:

\begin{lstlisting}
n = 7
E_sub_std = []
for burst in bursts_d:
    E_sub = []
    startlist = range(burst.istart, burst.istop + 2 - n, n)
    stoplist = [i + n for i in startlist]
    for start, stop in zip(startlist, stoplist): 
        A_D = DexAem_mask_d[start:stop].sum()
        E = A_D / n
        E_sub.append(E)
    E_sub_std.append(np.std(E_sub))
\end{lstlisting}

Here, \verb|n| is the BVA parameter defining the number of photons in each sub-burst. 
The outer loop, iterates through bursts, while the inner loop iterates through sub-bursts.
The variables \verb|startlist| and \verb|stoplist| are the list of start-stop indexes for
all sub-bursts in current burst.
In the inner loop, \verb|A_D| and \verb|E| contain the number of acceptor photons and 
FRET efficiency for the current sub-burst. Finally, for each burst, the standard deviation 
of \verb|E| is appended to \verb|E_sub_std|.

By plotting the 2D distribution of $s_E$ (i.e. \verb|E_sub_std|) versus the average (uncorrected) E 
we obtain the BVA plots of figure~\ref{fig:bva_static} and~\ref{fig:bva_dynamic}.

